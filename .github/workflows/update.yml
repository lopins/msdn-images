name: Update JSON Files - CI

on:
  schedule:
    # æ¯å‘¨æ—¥å‡Œæ™¨ 0 ç‚¹æ‰§è¡Œä¸€æ¬¡
    - cron: "0 0 * * 0"
  push:
    paths-ignore:
      - "LICENSE"
      - "README.md"
      - "README_**"
      - "README-**"
    branches:
      - main
  workflow_dispatch: 

permissions:
  contents: write

jobs:
  download-and-upload:
    runs-on: ubuntu-latest

    steps:
      # æ£€å‡ºéœ€è¦ä½¿ç”¨çš„ä»£ç åˆ°å·¥ä½œåŒº
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # ä¿ç•™ä»»ä½•å‡­è¯(åç»­git pushéœ€è¦ä½¿ç”¨)
          persist-credentials: true
          ref: main

      # å»ºç«‹ Python ç¯å¢ƒå’ŒåŒ…
      - name: Install Python, pipenv and Pipfile packages
        uses: palewire/install-python-pipenv-pipfile@v4
        with:
          # Netlifyè¿è¡Œç¯å¢ƒ: https://github.com/netlify/build-image/blob/focal/included_software.md
          python-version: '3.8'

      # è¿è¡Œæœ¬ä»“åº“æ–‡ä»¶
      - name: update-json-files
        # # å¦‚æœæ˜¯ Secrets å˜é‡, åˆ™å¯ç”¨è¿™é‡Œçš„è®¾ç½®
        # env:
        #   GPTAGENT_API_KEYS: ${{ secrets.GPTAGENT_API_KEYS }}
        #   WEB_PLATFORM_ARGS: ${{ secrets.WEB_PLATFORM_ARGS }}
        run: |
          # åŸŸåå¯ä»¥æ˜¯ï¼šmsdn.lopins.cnï¼Œmsdn.lopins.cn/docs
          pipenv run python main.py -d msdn.lopins.cn

      - name: Commit and Push
        run: |
          git diff --sparse || true
          if [ -n "$(git status --porcelain)" ]; then
            git config --global user.email "${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com"
            git config --global user.name "${{ github.actor }}"
            git add -A
            git commit -m "Updated JSON Files"
            git push
          else
            echo "No Required Updates"
          fi
      
      - name: Deploy ğŸš€
        uses: peaceiris/actions-gh-pages@v4
        with:   
          github_token: ${{ secrets.GITHUB_TOKEN }}       
          publish_branch: gh-pages  # default: gh-pages
          publish_dir: ./docs       # default: public
          cname: msdn.lopins.cn     # default: å¯é€‰ï¼šå¦‚æœä½¿ç”¨ username.github.io/repository å¯ä»¥ä¸è¦è¿™ä¸ªå‚æ•°
          # user_name: 'github-actions[bot]'
          # user_email: 'github-actions[bot]@users.noreply.github.com'
          # commit_message: ${{ github.event.head_commit.message }}
          # full_commit_message: ${{ github.event.head_commit.message }}
          # enable_jekyll: true